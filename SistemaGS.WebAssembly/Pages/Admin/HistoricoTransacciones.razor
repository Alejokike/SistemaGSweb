@page "/HistoricoTransacciones"
@inject ISecurityService securityService;
@inject NavigationManager navigationManager;

<ModalLayout Mostrar="Mostrar"
             Titulo="Seleccione el tipo de operación"
             TextoConfirmar="Cerrar"
             OnConfirmar="(() => {Mostrar = false; Registro = new RegistroDTO();})">
    <div class="mb-3">
        <div class="input-group col-6 mt-1">
            <label class="input-group-text bg-light">ID Transacción</label>
            <div class="form-control">@Registro.IdRegistro</div>
        </div>
    </div>
    <div class="mb-3">
        <label class="form-label fw-bold">Transacción</label>
        <div class="form-control">Acción: @Registro.Accion</div>
        <div class="form-control">Tabla Afectada: @Registro.TablaAfectada</div>
        <div class="form-control">ID Registro afectado: @Registro.IdRegistroAfectado</div>
    </div>
    <div class="mb-3">
        <div class="input-group col-6 mt-1">
            <label class="input-group-text bg-light">ID Usuario Responsable</label>
            <div class="form-control">@Registro.UsuarioResponsable</div>
        </div>
        <div class="input-group col-6 mt-1">
            <label class="input-group-text bg-light">Fecha de la transacción</label>
            <div class="form-control">@Registro.FechaAccion.ToString("dd/MM/yyyy")</div>
        </div>
    </div>
    <div class="mb-3">
        <label class="form-label fw-bold">Detalle</label>
        <div class="form-control">@Registro.Detalle</div>
    </div>
</ModalLayout>

<h3 class="m-3">Histórico de Transacciones</h3>

<div class="card mt-2 mb-2">
    <div class="card-body">
        <EditForm Model="filtro" OnValidSubmit="@(async () => await ListarMovimientos())">
            <div class="row-cols-12 mt-1">

                <div class="form-row mt-1">
                    <div class="input-group col-6 mt-1">
                        <label class="input-group-text bg-light">Usuario Responsable</label>
                        <InputNumber class="form-control" @bind-value="filtro.UsuarioResponsable" />
                    </div>

                    <div class="input-group col-6 mt-1">
                        <label class="input-group-text bg-light">Acción</label>
                        <InputText class="form-control" @bind-value="filtro.Accion" />
                    </div>
                    @* @if (Unidad)
                    {
                        <div class="input-group col-4 mt-1">
                            <label class="input-group-text bg-light">Unidad</label>
                            <InputSelect class="form-select" @bind-value="filtro.Unidad">
                                <option value="" selected>--Cualquiera</option>
                                <option value="EU">Unidad Estándar</option>
                                <option value="MU">Unidad Médica</option>
                                <option value="VE">Bolívares Fuertes</option>
                            </InputSelect>
                        </div>
                    } *@
                </div>

                <div class="form-row mt-1">
                    <div class="input-group col-6 mt-1">
                        <label class="input-group-text bg-light">Fecha inicial</label>
                        <InputDate class="form-control" @bind-value="filtro.FechaIni" />
                    </div>
                    <ValidationMessage For="@(() => filtro.FechaIni)" />
                    <div class="input-group col-6 mt-1">
                        <label class="input-group-text bg-light">Fecha final</label>
                        <InputDate class="form-control" @bind-value="filtro.FechaFin" />
                    </div>
                    <ValidationMessage For="@(() => filtro.FechaIni)" />
                </div>

                <div class="form-row mt-2">
                    <button class="btn btn-outline-secondary col-12" style="width:130px" type="submit">
                        <i class="oi oi-magnifying-glass"></i> Aplicar filtros
                    </button>
                </div>
            </div>
        </EditForm>
    </div>
</div>

<TableLayout listaOrigen="lista" T="RegistroDTO" MostrarOpcionales="false" Retorno="EventCallback.Factory.Create<RegistroDTO>(this, CargarTransaccion)"/>

@code {
    [Inject]
    private LoadingService loadingService { get; set; } = default!;

    List<RegistroDTO> lista = new List<RegistroDTO>();
    RegistroQuery filtro = new RegistroQuery();
    bool Mostrar = false;
    RegistroDTO Registro = new RegistroDTO();
    protected override async Task OnInitializedAsync()
    {
        await ListarMovimientos();
    }
    private async Task ListarMovimientos()
    {
        if (loadingService.IsLoading) return;
        loadingService.Show();
        var response = await securityService.Listar(filtro);
        loadingService.Hide();
        if (response.EsCorrecto && response.Resultado != null) lista = response.Resultado;
    }
    private void CargarTransaccion(RegistroDTO registro)
    {
        Registro = registro;
    }
}
