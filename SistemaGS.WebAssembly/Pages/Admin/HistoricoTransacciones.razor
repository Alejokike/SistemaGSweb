@page "/HistoricoTransacciones"

@inject ISecurityService securityService;
@inject NavigationManager navigationManager;

@attribute [Authorize(Roles = "Administrador")]

<ModalLayout Mostrar="Mostrar"
             MostrarCancelar ="false"
             Titulo="Detalle Registro"
             TextoConfirmar="Cerrar"
             OnCerrar="@(() => {Mostrar = false; Registro = new RegistroDTO();})"
             OnConfirmar="@(() => {Mostrar = false; Registro = new RegistroDTO();})">
    <div class="mb-3">
        <label class="form-label fw-bold">ID Transacción</label>
        <div class="form-label">@Registro.IdRegistro</div>
    </div>
    <div class="mb-3">
        <label class="form-label fw-bold">Transacción</label>
        <div class="form-label">Acción: @Registro.Accion</div>
        <div class="form-label">Tabla Afectada: @Registro.TablaAfectada</div>
        <div class="form-label">ID Registro afectado: @Registro.IdRegistroAfectado</div>

        <label class="form-label fw-bold mt-1">ID Usuario Responsable</label>
        <div class="form-label">@Registro.UsuarioResponsable</div>

        <label class="form-label fw-bold mt-1">Fecha de la transacción</label>
        <div class="form-label">@Registro.FechaAccion.ToString("dd/MM/yyyy")</div>
    </div>
    <div class="mb-3">
        <label class="form-label fw-bold">Detalle</label>
        <pre class="bg-light p-2">@Formato(Registro.Detalle)</pre>
        
    </div>
</ModalLayout>

<h3 class="m-3">Histórico de Transacciones</h3>

<div class="card mt-2 mb-2">
    <div class="card-body">
        <EditForm Model="filtro" OnValidSubmit="@(async () => await ListarMovimientos())">
            <div class="row-cols-12 mt-1">

                <div class="form-row mt-1">
                    <div class="input-group col-6 mt-1">
                        <label class="input-group-text bg-light">Usuario Responsable</label>
                        <InputNumber class="form-control" @bind-value="filtro.UsuarioResponsable" />
                    </div>

                    <div class="input-group col-6 mt-1">
                        <label class="input-group-text bg-light">Acción</label>
                        <InputText class="form-control" @bind-value="filtro.Accion" />
                    </div>
                    @* @if (Unidad)
                    {
                        <div class="input-group col-4 mt-1">
                            <label class="input-group-text bg-light">Unidad</label>
                            <InputSelect class="form-select" @bind-value="filtro.Unidad">
                                <option value="" selected>--Cualquiera</option>
                                <option value="EU">Unidad Estándar</option>
                                <option value="MU">Unidad Médica</option>
                                <option value="VE">Bolívares Fuertes</option>
                            </InputSelect>
                        </div>
                    } *@
                </div>

                <div class="form-row mt-1">
                    <div class="input-group col-6 mt-1">
                        <label class="input-group-text bg-light">Fecha inicial</label>
                        <InputDate class="form-control" @bind-value="filtro.FechaIni" />
                    </div>
                    <ValidationMessage For="@(() => filtro.FechaIni)" />
                    <div class="input-group col-6 mt-1">
                        <label class="input-group-text bg-light">Fecha final</label>
                        <InputDate class="form-control" @bind-value="filtro.FechaFin" />
                    </div>
                    <ValidationMessage For="@(() => filtro.FechaIni)" />
                </div>

                <div class="form-row mt-2">
                    <button class="btn btn-outline-secondary col-12" style="width:130px" type="submit">
                        <i class="oi oi-magnifying-glass"></i> Aplicar filtros
                    </button>
                </div>
            </div>
        </EditForm>
    </div>
</div>

<TableLayout listaOrigen="lista" T="RegistroDTO" MostrarOpcionales="false" Retorno="EventCallback.Factory.Create<RegistroDTO>(this, CargarTransaccion)"/>

@code {
    [Inject]
    private LoadingService loadingService { get; set; } = default!;

    List<RegistroDTO> lista = new List<RegistroDTO>();
    RegistroQuery filtro = new RegistroQuery();
    bool Mostrar = false;
    RegistroDTO Registro = new RegistroDTO();
    protected override async Task OnInitializedAsync()
    {
        await ListarMovimientos();
    }
    private async Task ListarMovimientos()
    {
        if (loadingService.IsLoading) return;
        loadingService.Show();
        var response = await securityService.Listar(filtro);
        loadingService.Hide();
        if (response.EsCorrecto && response.Resultado != null) lista = response.Resultado;
    }
    private string Formato(string jsonCrudo)
    {
        if (!Mostrar) return "";
        var parsed = Newtonsoft.Json.Linq.JObject.Parse(jsonCrudo);
        if (parsed.TryGetValue("Detalle", out var detalleToken)) 
        { 
            var detalleString = detalleToken?.ToString(); 
            if (!string.IsNullOrWhiteSpace(detalleString)) 
            { 
                try 
                {
                    var innerArray = Newtonsoft.Json.Linq.JArray.Parse(detalleString); 
                    parsed["Detalle"] = innerArray; 
                } 
                catch 
                {
                    try 
                    { 
                        var innerObj = Newtonsoft.Json.Linq.JObject.Parse(detalleString); 
                        parsed["Detalle"] = innerObj; 
                    } 
                    catch
                    {
                        
                    } 
                } 
            } 
        }
        return parsed.ToString(Newtonsoft.Json.Formatting.Indented);
    }
    private void CargarTransaccion(RegistroDTO registro)
    {
        Registro = registro;
        Mostrar = true;
    }
}