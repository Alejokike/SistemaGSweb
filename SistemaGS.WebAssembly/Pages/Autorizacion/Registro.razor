@page "/Register"
@layout LoginLayout

@inject IUsuarioService _usuarioService;
@inject NavigationManager navManager;
@inject IToastService _toastService;
@inject AuthenticationStateProvider authenticationStateProvider;

<div class="col-lg-8 mb-5">
    <div class="card rounded-lg mt-5">
        <div class="card-header border-yellow-600">
            <h3 class="text-2xl text-center font-weight-bold my-4 drop-shadow-lg tracking-wide">Crear Cuenta</h3>
        </div>
        <div class="card-body">
            <ul class="nav nav-tabs mb-3">
                <li class="nav-item">
                    <button class="nav-link @(activeTab == "cuenta" ? "active" : "")" @onclick="@(() => activeTab = "cuenta")">Datos Cuenta</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link @(activeTab == "personal" ? "active" : "")" @onclick="@(() => {activeTab = "personal"; model.Persona.Cedula = model.Cedula; model.Rol.IdRol = 3; model.Rol.Nombre = "Solicitante";})">Datos Personales</button>
                </li>
            </ul>

            <div class="tab-content">
                <div class="row justify-content-center gap-2 mt-3">
                    <div class="col-sm-12 col-md-8 col-xl-10">
                        <EditForm EditContext="@editContext" OnValidSubmit="GuardarCambios">
                            <ValidationSummary />
                            @if (activeTab == "cuenta")
                            {
                                <div class="input-group">
                                    <span class="input-group-text bg-light" id="basic-addon3">Cédula</span>
                                    <input type="text" maxlength="8" class="form-control" @bind-value="model.Cedula" @oninput=@(() => model.Persona.Cedula = model.Cedula)>
                                </div>
                                <ValidationMessage For="@(() => model.Cedula)" />

                                <div class="input-group mt-3">
                                    <span class="input-group-text bg-light" id="basic-addon3">Nombre de Usuario</span>
                                    <input type="text" class="form-control" maxlength="50" @bind-value="model.NombreUsuario">
                                </div>
                                <ValidationMessage For="@(() => model.NombreUsuario)" />

                                <div class="input-group mt-3">
                                    <span class="input-group-text bg-light" id="basic-addon3">Correo</span>
                                    <input type="text" class="form-control" maxlength="50" @bind-value="model.Correo">
                                </div>
                                <ValidationMessage For="@(() => model.Correo)" />

                                <div class="input-group mt-3">
                                    <span class="input-group-text bg-light" id="basic-addon3">Contraseña</span>
                                    <input type="password" class="form-control" @bind-value="model.Clave">
                                </div>
                                <ValidationMessage For="@(() => model.Clave)" />

                                <div class="input-group mt-3">
                                    <span class="input-group-text bg-light" id="basic-addon3">Confirmar Contraseña</span>
                                    <input type="password" class="form-control" @bind-value="model.ConfirmarClave">
                                </div>
                                <ValidationMessage For="@(() => model.ConfirmarClave)" />

                                <div class="mt-3">
                                    <button type="submit" disabled="@(loadingService.IsLoading ? true : null)" class="btn btn-primary m-3">Registrarse</button>
                                </div>
                            }
                            else
                            {
                                <div class="input-group">
                                    <span class="input-group-text bg-light" id="basic-addon3">Cédula</span>
                                    <InputNumber maxlength="8" class="form-control" readonly @bind-value="model.Persona.Cedula" />
                                </div>
                                <ValidationMessage For="@(() => model.Persona.Cedula)" />

                                <div class="form-row mt-3">
                                    <div class="input-group col-md-6 mb-1">
                                        <ValidationMessage For="@(() => model.Persona.Nombre)" />
                                    </div>
                                    <div class="input-group col-md-6 mb-1">
                                        <ValidationMessage For="@(() => model.Persona.Apellido)" />
                                    </div>
                                </div>

                                <div class="form-row mt-3">
                                    <div class="input-group col-md-6 mb-1">
                                        <span class="input-group-text bg-light" id="basic-addon3">Nombres</span>
                                        <InputText maxlength="60" class="form-control" @bind-value="model.Persona.Nombre" />
                                    </div>

                                    <div class="input-group col-md-6 mb-1">
                                        <span class="input-group-text bg-light" id="basic-addon3">Apellidos</span>
                                        <InputText maxlength="60" class="form-control" @bind-value="model.Persona.Apellido" />
                                    </div>
                                </div>

                                <div class="input-group mt-3">
                                    @* validar *@
                                    <span class="input-group-text bg-light" id="basic-addon3">Fecha de nacimiento</span>
                                    <InputDate max="@DateTime.Today.ToString("yyyy-MM-dd")" class="form-control" id="birthdaytime" name="birthdaytime" @bind-value="model.Persona.FechaNacimiento" />
                                </div>
                                <ValidationMessage For="@(() => model.Persona.FechaNacimiento)" />

                                bool Masc = model.Persona.Genero == "M";

                                <div class="mt-3">
                                    <label class="form-label d-block">Género</label>
                                    <InputRadioGroup @bind-value="model.Persona.Genero" class="form-check form-check-inline">
                                        <div class="form-check form-check-inline">
                                            <InputRadio class="form-check-input" Value=@("M") id="generoMasculino" />
                                            <label class="form-check-label" for="generoMasculino">Masculino</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <InputRadio class="form-check-input" Value=@("F") id="generoFemenino" />
                                            <label class="form-check-label" for="generoFemenino">Femenino</label>
                                        </div>
                                    </InputRadioGroup>
                                </div>
                                <ValidationMessage For="@(() => model.Persona.Genero)" />

                                <div class="form-row mt-3">
                                    <div class="input-group col-md-6 mb-1">
                                        <ValidationMessage For="@(() => model.Persona.Profesion)" />
                                    </div>
                                    <div class="input-group col-md-6 mb-1">
                                        <ValidationMessage For="@(() => model.Persona.Ocupacion)" />
                                    </div>
                                </div>

                                <div class="form-row mt-3">
                                    <div class="input-group col-md-6 mb-1">
                                        <span class="input-group-text bg-light" id="basic-addon3">Profesión</span>
                                        <InputText maxlength="30" class="form-control" @bind-value="model.Persona.Profesion" />
                                    </div>

                                    <div class="input-group col-md-6 mb-1">
                                        <span class="input-group-text bg-light" id="basic-addon3">Ocupación</span>
                                        <InputText maxlength="30" class="form-control" @bind-value="model.Persona.Ocupacion" />
                                    </div>
                                </div>

                                <div class="input-group mt-3">
                                    <span class="input-group-text bg-light" id="basic-addon3">Lugar de Trabajo</span>
                                    <InputText maxlength="60" class="form-control" @bind-value="model.Persona.LugarTrabajo" />
                                </div>
                                <ValidationMessage For="@(() => model.Persona.LugarTrabajo)" />

                                <div class="input-group mt-3">
                                    <span class="input-group-text bg-light" id="basic-addon3">Dirección de Trabajo</span>
                                    <InputText maxlength="150" class="form-control" @bind-value="model.Persona.DireccionTrabajo" />
                                </div>
                                <ValidationMessage For="@(() => model.Persona.DireccionTrabajo)" />

                                <div class="input-group mt-3">
                                    <span class="input-group-text bg-light" id="basic-addon3">Teléfono de trabajo</span>
                                    <InputText maxlenght="12" class="form-control" @bind-value="model.Persona.TelefonoTrabajo" />
                                </div>
                                <ValidationMessage For="@(() => model.Persona.TelefonoTrabajo)" />

                                <div class="input-group mt-3">
                                    <span class="input-group-text bg-light" id="basic-addon3">Dirección de habitación</span>
                                    <InputText maxlength="150" class="form-control" @bind-value="model.Persona.DireccionHabitacion" />
                                </div>
                                <ValidationMessage For="@(() => model.Persona.DireccionHabitacion)" />

                                <div class="input-group mt-3">
                                    <span class="input-group-text bg-light" id="basic-addon3">Teléfono de habitación</span>
                                    <InputText maxlenght="12" class="form-control" @bind-value="model.Persona.TelefonoHabitacion" />
                                </div>
                                <ValidationMessage For="@(() => model.Persona.TelefonoHabitacion)" />
                            }
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-footer text-center py-3">
            <div class="small"><a href="/login">Tienes una cuenta? ir a login</a></div>
        </div>
    </div>
</div>

@code {
    [Inject]
    private LoadingService loadingService { get; set; } = default!;

    private UsuarioDTO model = new UsuarioDTO() {Persona = new PersonaDTO(), Rol = new RolDTO()};

    private string activeTab = "cuenta";

    public required EditContext editContext;
    public required ValidationMessageStore messageStore;

    protected override void OnInitialized()
    {
        editContext = new EditContext(model);
        messageStore = new ValidationMessageStore(editContext);

        editContext.OnValidationRequested += (sender, args) =>
        {
            messageStore.Clear();

            var results = Utilidades.ValidateRecursive(model);
            foreach (var result in results)
            {
                foreach (var memberName in result.MemberNames)
                {
                    if (memberName.StartsWith("Persona."))
                    {
                        var subName = memberName.Substring("Persona.".Length);
                        var fieldIdentifier = new FieldIdentifier(model.Persona, subName);
                        messageStore.Add(fieldIdentifier, result.ErrorMessage ?? "");
                    }
                    else if (memberName.StartsWith("Rol."))
                    {
                        var subName = memberName.Substring("Rol.".Length);
                        var fieldIdentifier = new FieldIdentifier(model.Rol, subName);
                        messageStore.Add(fieldIdentifier, result.ErrorMessage ?? "");
                    }
                    else
                    {
                        var fieldIdentifier = new FieldIdentifier(model, memberName);
                        messageStore.Add(fieldIdentifier, result.ErrorMessage ?? "");
                    }
                }
            }
            editContext.NotifyValidationStateChanged();
        };
    }

    // bool esRegistro = false;
    string ClaveTemporal = "";
    string Clave = "";
    DateTime expires;

    private async Task ConfirmarClave()
    {
        if(loadingService.IsLoading) return;

        if (model.Clave != model.ConfirmarClave)
        {
            _toastService.ShowWarning("Las contrasñas no coinciden");
            return;
        }
        if(expires < DateTime.Now)
        {
            _toastService.ShowWarning("Clave temporal vencida");
            return;
        }
        if(ClaveTemporal != Clave)
        {
            _toastService.ShowError("Clave inválida");
            return;
        }

        await GuardarCambios();
    }

    private async Task GuardarCambios()
    {
        if(loadingService.IsLoading) return;

        if (model.Persona.FechaNacimiento > DateTime.Today)
        {
            _toastService.ShowWarning("La fecha de nacimiento no puede ser mayor a la fecha actual");
            return;
        }

        if(model.Clave != model.ConfirmarClave)
        {
            _toastService.ShowWarning("Las contrasñas no coinciden");
            return;
        }

        model.Rol.IdRol = 3;
        model.Activo = true;
        model.ResetearClave = true;
        model.FechaCreacion = DateTime.Now;

        loadingService.Show();
        var response = await _usuarioService.Crear(model);
        loadingService.Hide();

        if (response.EsCorrecto)
        {
            _toastService.ShowSuccess("Su cuenta ha sido Creada");
            navManager.NavigateTo("/login");
        }
        else
        {
            _toastService.ShowWarning("No se pudo crear su cuenta");
            return;
        }

        var AuthExt = (AutExt) authenticationStateProvider;
        await AuthExt.ActualizarEstadoAut(null);
    }
}