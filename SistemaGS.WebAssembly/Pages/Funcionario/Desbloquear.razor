@page "/Desbloquear"
@page "/Desbloquear/{IDAyuda:int}"

@inject NavigationManager navigationManager;
@inject IInventarioService inventarioService;
@inject IAyudaService ayudaService;
@inject IToastService toastService;
@inject SweetAlertService Swat;

@attribute [Authorize(Roles = "Funcionario")]

<AuthorizeView>
    <Authorized>
        @{
            cedula = Convert.ToInt32((context.User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.NameIdentifier)!.Value ?? "0"));
        }
    </Authorized>
</AuthorizeView>

<PageTitle>Desbloquear Ayuda</PageTitle>

<style>
    th {
        vertical-align: middle !important;
        text-align: center;
    }
</style>

<h3 class="m-3">Desbloquear Ayuda</h3>

<ModalLayout
    Mostrar="Mostrar"
    Titulo="Seleccione el tipo de operación"
    TextoConfirmar="Ejecutar"
    TextoCancelar="Cancelar"
    OnCerrar="(() => Mostrar = false)"
    OnConfirmar="EventCallback.Factory.Create(this, Transaccion)">
    
    <div class="form-label fw-bold mb-1">Tipo de operación</div>
    <InputSelect class="form-select mb-2" @bind-Value="movimiento">
        <option value="ASI" selected>Asignación</option>
        <option value="RET">Retiro</option>
    </InputSelect>

    <div class="form-label fw-bold mb-1">Cantidad</div>
    <InputNumber class="form-control" min"="0" max="9999999" maxlenght="7" @bind-Value="cantidad"/>

</ModalLayout>

<div class="d-flex flex-column min-vh-90">
    @* Formulario Ayuda *@
    <div class="flex-grow-1">
        <div class="row-cols-12 mt-3">
            <div class="col-sm-12">
                <div class="card mb-3">
                    <div class="card-body">

                        @if (ayuda.Detalle.TryGetValue("Observaciones", out string? observaciones) && !string.IsNullOrEmpty(observaciones))
                        {
                            <div class="mb-3">
                                <label class="form-label fw-bold">Observaciones del funcionario</label>
                                <div class="form-control">@observaciones</div>
                            </div>
                        }

                        <div class="mb-3">
                        <label class="form-label fw-bold">Categoría de la ayuda</label>
                        <div class="form-control">@ayuda.Categoria</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @* Lista Items *@

        <div class="row-cols-12 mt-4">

            <div class="col-sm-12">
                <div class="card mb-3">

                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm bg-light table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>Código ítem</th>
                                        <th>Nombre</th>
                                        <th>Categoria</th>
                                        <th>Unidad</th>
                                        <th>Cantidad Solicitada</th>
                                        <th>Cantidad Entregada</th>
                                        <th>Stock en Inventario</th>
                                        <th>Cantidad a mover</th>
                                        <th>Asignar</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (ayuda.ListaItems.Any())
                                    {
                                        foreach (var item in ayuda.ListaItems)
                                        {
                                            var mov = movimientos.FirstOrDefault(m => m.Item.IdItem == item.ItemLista.IdItem);
                                            mov ??= new InventarioDTO();
                                            string signo = !string.IsNullOrEmpty(mov.TipoOperacion) ? (mov.TipoOperacion == "ASI" ? "+" : "-") : "";
                                            string color = !string.IsNullOrEmpty(mov.TipoOperacion) ? (mov.TipoOperacion == "ASI" ? "text-success" : "text-danger") : "text-light";
                                            <tr>
                                                <td valign="middle" align="center">@item.IdLista</td>
                                                <td valign="middle" align="center">@item.ItemLista.IdItem</td>
                                                <td valign="middle" align="center">@item.ItemLista!.Nombre</td>
                                                <td valign="middle" align="center">@item.ItemLista!.Categoria</td>
                                                <td valign="middle" align="center">@item.ItemLista!.Unidad</td>
                                                <td valign="middle" align="center">@item.CantidadSolicitada</td>
                                                <td valign="middle" align="center">@item.CantidadEntregada</td>
                                                <td valign="middle" align="center">@item.ItemLista.Cantidad</td>
                                                <td valign="middle" align="center" class="@color">@($"{signo}{mov.Cantidad.ToString("N2")}")</td>

                                                <td align="center">
                                                    <button class="btn btn-light" @onclick="@(() => {Mostrar = true; position = item;})">
                                                        <i class="bi bi-pencil-square"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    }
                                    else
                                    {
                                        <tr>
                                            <td colspan="7">
                                                <div class="alert alert-warning" role="alert">
                                                    No hay productos en la lista
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>

    @* Lista Movimientos *@

    <div class="row-cols-12 mt-4">
        <div class="col-sm-12">
            <div class="card mb-3">
                <div class="card-body">
                    <TableLayout 
                        listaOrigen="movimientos" 
                        T="InventarioDTO" 
                        MostrarBotones="false" />
                </div>
            </div>
        </div>
    </div>
</div>

<div class="bg-light p-3 mt-5">
    <div class="d-flex justify-content-center align-items-center gap-5">
        <button class="btn btn-info" style="width: 500px" @onclick="Guardar">Desbloquear ayuda</button>
    </div>
</div>

@code {
    [Parameter]
    public int IDAyuda { get; set; }

    [Inject]
    private LoadingService loadingService { get; set; } = default!;

    private int cedula;
    private bool Mostrar = false;
    private ListaItemDTO position = new ListaItemDTO();
    string movimiento = "ASI";
    decimal cantidad = 0;

    private List<InventarioDTO> movimientos = new List<InventarioDTO>();

    AyudaDTO ayuda = new AyudaDTO()
    {
        ListaItems = new List<ListaItemDTO>(),
        Detalle = new Dictionary<string, string>
        {
            ["Solicitud"] = "",
            ["Observaciones"] = "",
            ["Aprobado"] = "",
            ["Rechazado"] = ""
        }
    };

    protected override async Task OnParametersSetAsync()
    {
        if (loadingService.IsLoading) return;
        loadingService.Show();
        var response = await ayudaService.Obtener(IDAyuda);
        loadingService.Hide();
        if (response.EsCorrecto && response.Resultado != null)
        {
            if (response.Resultado.ListaItems.Any(Li => Li.ItemLista!.IdItem == 0))
            {
                toastService.ShowError("Hay ítems en la lista sin normalizar");
                navigationManager.NavigateTo($"/GestionarAyudas/{cedula}");
                return;
            }
            ayuda = response.Resultado;
        }

        if (ayuda.Funcionario != cedula) navigationManager.NavigateTo($"/GestionarAyudas/{cedula}");
    }
    private void Transaccion()
    {
        Mostrar = false;
        if (movimiento == "ASI") Asignar(position,cantidad);
        else Retirar(position,cantidad);
        position = new ListaItemDTO();
        cantidad = 0;
    }
    private void Asignar(ListaItemDTO item, decimal cantidad)
    {
        if (item.ItemLista.Unidad != "VE") cantidad = Math.Floor(cantidad);

        bool val1 = (item.ItemLista.IdItem) < cantidad;
        bool val2 = cantidad < 0;
        bool val3 = cantidad > item.CantidadSolicitada;

        if (val1 || val2 || val3)
        {
            if(val1) toastService.ShowWarning("No hay el stock necesario para asignar esa cantidad");
            if(val2) toastService.ShowWarning("La cantidad a asignar no puede ser negativa");
            if(val3) toastService.ShowWarning("No se puede asignar más stock del solicitado");
            return;
        }

        var encontrado = movimientos.FirstOrDefault(m => m.Item.IdItem == item.ItemLista.IdItem);
        if (encontrado == null)
        {
            if (cantidad == 0) return;
            movimientos.Add(new InventarioDTO()
                {
                    TipoOperacion = "ASI",
                    Item = item.ItemLista,
                    Unidad = item.ItemLista.Unidad,
                    Cantidad = cantidad,
                    Concepto = $"Asignación ayuda {ayuda.IdAyuda}; posición {item.IdLista}",
                    Fecha = DateTime.Today
                });
        }
        else 
        {
            movimientos.Remove(encontrado);
            if (cantidad == 0) return;
            encontrado.Cantidad = cantidad;
            movimientos.Add(encontrado);
        }
    }
    private void Retirar(ListaItemDTO item, decimal cantidad)
    {
        if (item.ItemLista.Unidad != "VE") cantidad = Math.Floor(cantidad);

        bool val1 = item.CantidadEntregada < cantidad;
        bool val2 = cantidad < 0;

        if (val1 || val2)
        {
            if (val1) toastService.ShowWarning("No se puede retirar más de lo asignado");
            if (val2) toastService.ShowWarning("La cantidad a retirar no puede ser negativa");
            return;
        }

        var encontrado = movimientos.FirstOrDefault(m => m.Item.IdItem == item.ItemLista.IdItem);
        if (encontrado == null)
        {
            if (cantidad == 0) return;
            movimientos.Add(new InventarioDTO()
            {
                TipoOperacion = "RET",
                Item = item.ItemLista,
                Unidad = item.ItemLista.Unidad,
                Cantidad = cantidad,
                Concepto = $"Retiro ayuda {ayuda.IdAyuda}; posición {item.IdLista}",
                Fecha = DateTime.Today
            });
        }
        else
        {
            movimientos.Remove(encontrado);
            if (cantidad == 0) return;
            encontrado.Cantidad = cantidad;
            movimientos.Add(encontrado);
        }
    }

    private async Task Guardar()
    {
        if (loadingService.IsLoading) return;
        loadingService.Show();
        var response = await inventarioService.Desbloquear(movimientos, ayuda.IdAyuda);
        loadingService.Hide();
        if (response.EsCorrecto) navigationManager.NavigateTo("/Ayudas");
        else toastService.ShowError($"Error: {response.Mensaje}");
    }

    // private async Task<decimal> ObtenerStock(int idItem)
    // {
    //     var response = await inventarioService.ObtenerItem(idItem);
    //     if (response.EsCorrecto && response.Resultado != null) return response.Resultado.Cantidad;
    //     else return 0;
    // }
}
