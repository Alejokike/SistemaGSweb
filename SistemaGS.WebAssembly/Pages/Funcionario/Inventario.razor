@page "/Inventario"

@inject IInventarioService inventarioService;
@inject IToastService toastService;
@inject NavigationManager _navService;
@inject AuthenticationStateProvider authenticationStateProvider;

@attribute [Authorize(Roles = "Funcionario")]

<PageTitle>Inventario</PageTitle>

<div class="row-cols-12 mt-4 align-items-sm-center">
    <div class="col-sm-12">

        <ul class="nav nav-tabs mb-3">
            <li class="nav-item">
                <button class="nav-link @(activeTab == "inventario" ? "active" : null)" @onclick="@(() => {activeTab = "inventario"; })">Inventario</button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(activeTab == "historico" ? "active" : null)" @onclick="@(() => { activeTab = "historico";})">Movimientos</button>
            </li>
        </ul>

        <div class="tab-content">

            <div class="card mb-3">
                @if (activeTab == "inventario")
                {
                    <InventarioItems Estado="false" retorno="@((ItemDTO r) => {model.Item  = r; agregar = false;})"/>
                }
                else
                {
                    <InventarioMovimientos />
                }
            </div>
        </div>
    </div>
</div>

@*Realizar Operación*@

<div class="row-cols-12 mt-3">
    <div class="col-sm-12">
        <div class="card mb-3">

            <div class="card-header text-center">
                <h5>Realizar movimiento</h5>
            </div>

            <div class="card-body">

                @* <div class="input-group mt-2 mb-2">
                    <label class="input-group-text bg-light">Cargar ítem</label>
                    <InputNumber min="0" step="1" class="form-control" placeholder="Ingresa el ID del ítem del movimiento" @bind-value="@id" oninput="this.value = this.value.replace(/[^0-9]/g,'')" />
                    <i class="bi bi-info-circle input-group-text bg-primary text-white fs-5" title="Para dar entrada a un ítem que no exista en inventario, dejar el campo en 0"></i>
                    <button type="button" class="btn btn-light" @onclick="@( async() => {await ObtenerItem(id); id = 0;})">
                        <i class="bi bi-pencil-square text-primary fs-5"></i>
                    </button>
                </div> *@

                <EditForm EditContext="@editContext" OnValidSubmit="async () => await RegistrarOperacion()">
                    <ValidationSummary />

                    <div class="input-group mt-3">
                        <label class="input-group-text bg-light">Movimiento</label>
                        <InputSelect class="form-select" @bind-value="model.TipoOperacion">
                            <option value="" selected>--Seleccione tipo de operación</option>
                            <option value="REC">Recarga</option>
                            <option value="DEV">Devolución</option>
                        </InputSelect>
                    </div>
                    <ValidationMessage For="@(() => model.TipoOperacion)" />

                    @* Crear o dar entrada/salida item*@

                    <div class="form-row mt-3 mb-2">

                        <div class="col-md-4 flex-column">
                            <div class="input-group">
                                <label class="input-group-text bg-light">ID ítem</label>
                                <InputNumber min="0" class="form-control" disabled @bind-value="model.Item.IdItem"/>
                            </div>
                            <ValidationMessage For="@(() => model.Item.IdItem)" />
                        </div>

                        <div class="col-md-4 flex-column">
                            <div class="input-group">
                                <label class="input-group-text bg-light">Nombre</label>
                                <InputText class="form-control" disabled="@(agregar ? null : true)" @bind-value="model.Item.Nombre" />
                            </div>
                            <ValidationMessage For="@(() => model.Item.Nombre)" />
                        </div>

                        <div class="col-md-4 flex-column">
                            <div class="input-group">
                                <label class="input-group-text bg-light">Categoría</label>
                                <InputSelect class="form-select" disabled="@(agregar ? null : true)" @bind-value="model.Item.Categoria">
                                    <option value="" selected>--Seleccione una categoría</option>
                                    <option value="Médicamentos">Médicamentos</option>
                                    <option value="Insumos quirúrgicos">Insumos quirúrgicos</option>
                                    <option value="Prótesis">Prótesis</option>
                                    <option value="Equipos de movilidad asistida">Equipos de movilidad asistida</option>
                                    <option value="Servicios médicos">Servicios médicos</option>
                                    <option value="Bienes de apoyo social">Bienes de apoyo social</option>
                                    <option value="Fondos y financiamiento">Fondos y financiamiento</option>
                                    <option value="Otros">Otros</option>
                                </InputSelect>
                            </div>
                            <ValidationMessage For="@(() => model.Item.Categoria)" />
                        </div>

                    </div>

                    <span class="form-label mt-3" id="basic-addon3">Descripción</span>
                    <InputTextArea class="form-control" disabled="@(agregar ? null : true)" placeholder="Ingrese para que sirve el ítem" @bind-value="model.Item.Descripcion" />
                    <ValidationMessage For="@(() => model.Item.Descripcion)" />

                    @*fin item*@

                    <div class="mb-3">
                        <label class="form-label"></label>
                        <InputSelect class="form-select" disabled="@(agregar ? null : true)" @bind-value="model.Item.Unidad" @onchange="() => model.Unidad = model.Item.Unidad">
                            <option value="" selected>--Seleccione una unidad</option>
                            <option value="EU">Unidad Estándar</option>
                            <option value="MU">Unidad Médica</option>
                            <option value="VE">Bolívares</option>
                        </InputSelect>
                        <ValidationMessage For="@(() => model.Item.Unidad)" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Concepto</label>
                        <InputTextArea class="form-control form-control-sm" placeholder="Ingrese el concepto del movimiento" @bind-value="model.Concepto" />
                        <ValidationMessage For="@(() => model.Concepto)" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Cantidad</label>
                        <InputNumber class="form-control" min="0" max="999999" maxlenght="6" @bind-value="model.Cantidad" />
                        <ValidationMessage For="@(() => model.Cantidad)" />
                    </div>
                    
                    <div class="mt-3">
                        <div class="d-grid gap-1">
                            <button class="btn btn-outline-primary float-end" type="submit">Cargar movimiento</button>
                        </div>
                    </div>

                </EditForm>
            </div>
        </div>
    </div>
</div>

@code{
    string activeTab = "inventario";

    private InventarioDTO model = new InventarioDTO()
    {
        Item = new ItemDTO()
    };

    public required EditContext editContext;
    public required ValidationMessageStore messageStore;

    protected override void OnInitialized()
    {
        editContext = new EditContext(model);
        messageStore = new ValidationMessageStore(editContext);

        editContext.OnValidationRequested += (sender, args) =>
        {
            messageStore.Clear();

            var results = Utilidades.ValidateRecursive(model);
            foreach (var result in results)
            {
                foreach (var memberName in result.MemberNames)
                {
                    if (memberName.StartsWith("Item."))
                    {
                        var subName = memberName.Substring("Item.".Length);
                        var fieldIdentifier = new FieldIdentifier(model.Item, subName);
                        messageStore.Add(fieldIdentifier, result.ErrorMessage ?? "");
                    }
                    else
                    {
                        var fieldIdentifier = new FieldIdentifier(model, memberName);
                        messageStore.Add(fieldIdentifier, result.ErrorMessage ?? "");
                    }
                }
            }
            editContext.NotifyValidationStateChanged();
        };
    }

    #region Registrar

    //private int id = 0;
    private bool agregar = true;

    private async Task ObtenerItem(int iditem)
    {
        if(iditem == 0)
        {
            model.Item = new ItemDTO();
            agregar = true;
            return;
        }

        var buscar = await inventarioService.ObtenerItem(iditem, "");
        if (buscar.EsCorrecto && buscar.Resultado != null)
        {
            model.Item = buscar.Resultado;
            agregar = false;
        }
        else
        {
            toastService.ShowInfo("Sin resultados");
            model.Item = new ItemDTO();
            agregar = true;
        }
    }

    private async Task RegistrarOperacion()
    {
        model.Unidad = model.Item.Unidad;
        model.Fecha = DateTime.Today;
        if (model.Unidad != "VE") model.Cantidad = Math.Floor(model.Cantidad);

        var response = await inventarioService.Registrar(model);

        if (response.EsCorrecto)
        {
            toastService.ShowSuccess("Movimiento registrado");
            model = new InventarioDTO(){Item = new ItemDTO()};
            agregar = true;
            StateHasChanged();
        }
        else toastService.ShowError($"Error: {response.Mensaje}");
    }
    #endregion
}